import Guide from '~/components/layout/guide'
import Snippet from '~/components/snippet'
import { InlineCode } from '~/components/text/code'
import { Image } from '~/components/media'
import Caption from '~/components/text/caption'
import Note from '~/components/text/note'
import { GenericLink } from '~/components/text/link'
import Card from '~/components/card'
import Example from '~/components/example'
import { Code } from '~/components/code'

export const meta = {
  title:
    'Create and Deploy a FaunaDB-powered Node.js API using ZEIT Now with Zero Config',
  description:
    'Learn how to create a FaunaDB backed Node.js API and deploy it with ZEIT Now.',
  published: '2019-08-12T17:00:00.000Z',
  authors: ['danieltodonnell'],
  url: `/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now`,
  image: `${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/card.png`,
  editUrl:
    'pages/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now.mdx',
  lastEdited: '2019-08-25T02:50:20.000Z'
}

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/card.png`}
  width={1200 / 1.5}
  height={628 / 1.5}
  oversize
/>

Finally, you can unlock the power of true serverless [JAMstack](https://jamstack.org/) architecture without sacrificing data correctness or reliability. ZEIT's serverless infrastructure lets you deploy your front-end and server resources [with zero config](https://zeit.co/guides/upgrade-to-zero-configuration). Complementing that, [FaunaDB](https://fauna.com/) is a serverless cloud database that lets you store your app data with zero provisioning, global low-latency and confidence.

This guide walks you through making a FaunaDB account, creating a sample database, and then connecting to it using a serverless function deploy with[ZEIT Now](/now).

## Step 1: Connecting to FaunaDB

To start this example, you need to have [created a FaunaDB account](https://dashboard.fauna.com/accounts/register).

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-register.png`}
  width={1934 / 2.5}
  height={1516 / 2.5}
  oversize
/>
<Caption>The FaunaDB login page.</Caption>

Once you have logged into your free account, create a child database named `zeit` _(names are case sensitive)_. You can have _almost unlimited_ child databases in your account.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-create-zeit-db.png`}
  width={1442 / 2}
  height={890 / 2}
  oversize
/>
<Caption>Creating a new database in the FaunaDB dashboard.</Caption>

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-home.png`}
  width={1942 / 2.5}
  height={1514 / 2.5}
  oversize
/>
<Caption>The FaunaDB dashboard after creating a new database.</Caption>

From here, the simplest way for us to create a demo schema with some data is to execute a _Fauna Query Language (FQL)_ script file in [the "Shell" in the side nav bar](https://dashboard.fauna.com/webshell/@db/zeit).

Select the **Shell** tab from the sidebar, copy in [this FQL script](https://raw.githubusercontent.com/danieltodonnell/faunadb-zeit-fql-demo/master/fql-scripts/ecommerce.fql) and click **Run Query**.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-shell.png`}
  width={1928 / 2.5}
  height={1508 / 2.5}
  oversize
/>
<Caption>Adding data to a FaunaDB database from the dashboard using a FQL script.</Caption>

After executing the script, your **Collections** page will look like this, you are now ready to create a connection to the database.

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-collections.png`}
  width={1942 / 2.5}
  height={1522 / 2.5}
  oversize
/>
<Caption>The Collections page on the FaunaDB dashboard after adding data to the database.</Caption>

## Step 2: Create An Access Key

FaunaDB’s **Attribute-Based Access Control** (ABAC) capabilities allow users to generate secure keys to access databases, collections, or even individual documents, based on simple (or complex) logic.

For this guide, you will generate an access key that gives you both read and write access to the `zeit` database you just created.

Go to the [**Security** page](https://dashboard.fauna.com/keys/@db/zeit) and click the **New Key** button. Enter the following data in the fields:

- Database: `zeit`
- Role: `Admin`
- Key Name: `access`
- Priority: `1`

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/fauna-zeit-db-security.png`}
  width={1934 / 2.5}
  height={1522 / 2.5}
  oversize
/>
<Caption>Viewing an <InlineCode>access key</InlineCode> on the FaunaDB dashboard.</Caption>

On the **Keys** page, you will receive a unique hash called a **Secret**, in the same format as the image above. The \*Secret\*\* is your method of securely identifying yourself to your database.

<Note warning>
  This is the only time you will see this hash, so record it somewhere private.
  However, if you ever lose this hash, you can create another.
</Note>

## Step 3: API Setup

Get started by creating a project directory and `cd` into it:

<Snippet dark text="mkdir faunadb-zeit-fql-demo && cd faunadb-zeit-fql-demo" />
<Caption>
  Creating and entering into the <InlineCode>/faunadb-zeit-fql-demo</InlineCode>{' '}directory.
</Caption>

Next, [initialize](https://yarnpkg.com/lang/en/docs/cli/init/) the project:

<Snippet dark text="yarn init" />
<Caption>
  Initializing the project, this creates a <InlineCode>package.json</InlineCode>{' '}file.
</Caption>

<Note hint>
  During the initializing process, Yarn will ask questions about your project.
  Answer these how you wish; there are no prerequisites for this example.
</Note>

Next, install [the FaunaDB Javascript client](https://github.com/fauna/faunadb-js), this helps you connect to and query your database:

<Snippet dark text="yarn add faunadb" />
<Caption>
  Adding the <InlineCode>faunadb</InlineCode> Node.js client as a <GenericLink href="https://yarnpkg.com/lang/en/docs/installing-dependencies/">dependency</GenericLink> to the project.
</Caption>

To connect, you need the secret that you saved earlier. To use your secret without hard-coding it into your project, you can add your connection string as a [Now Secret](https://zeit.co/docs/v2/deployments/environment-variables-and-secrets/#securing-environment-variables-using-secrets) using [Now CLI](https://zeit.co/download#now-cli) to keep it secure:

<Snippet dark text="now secrets add faunadb_secret_key YourFaunaDBSecret" />
<Caption>
  Adding an environment variable to the project as a secret.
</Caption>

Now, create a [`now.json` file](https://zeit.co/docs/v2/deployments/configuration/) that tells Now to make available the [Secret](https://zeit.co/docs/v2/deployments/environment-variables-and-secrets/#securing-environment-variables-using-secrets) that you defined:

```json
{
  "env": {
    "FAUNADB_SECRET_KEY": "@faunadb_secret_key"
  }
}
```

<Note hint>
  To use this environment variable in local development, you need to use a
  `.env` file.{' '}
  <GenericLink href="/docs/v2/serverless-functions/introduction/#local-development">
    Read more about local development and environment variables.
  </GenericLink>{' '}
</Note>

## Step 4: Writing the Serverless Function

It's time to create the Node.js API endpoint that will fetch the data from FaunaDB. Create an `/api` directory to put the serverless function in:

<Snippet dark text="mkdir api && cd api" />
<Caption>
  Creating and entering into the <InlineCode>/api</InlineCode>{' '}directory.
</Caption>

For this example, create a file called `index.js` in `/api`.

The `index.js` file will act as the default endpoint for getting information from your database. The file should contain the following contents:

```js
const faunadb = require('faunadb')

// your secret hash
const secret = process.env.FAUNADB_SECRET_KEY
const q = faunadb.query
const client = new faunadb.Client({ secret })

module.exports = async (req, res) => {
  try {
    const dbs = await client.query(
      q.Map(
        // iterate each item in result
        q.Paginate(
          // make paginatable
          q.Match(
            // query index
            q.Index('all_customers') // specify source
          )
        ),
        ref => q.Get(ref) // lookup each result by its reference
      )
    )
    // ok
    res.status(200).json(dbs.data)
  } catch (e) {
    // something went wrong
    res.status(500).json({ error: e.message })
  }
}
```

<Note hint>
  In the code snippet above, you probably noticed the use of{' '}
  <InlineCode>res.status()</InlineCode> and <InlineCode>res.json()</InlineCode>{' '}
  to send a response. These methods are automatically added for you when you use
  <InlineCode>@now/node</InlineCode>. Read more about this in the <GenericLink href="/docs/v2/deployments/official-builders/node-js-now-node#helpers">
    <InlineCode>@now/node</InlineCode> Builder documentation page
  </GenericLink>.
</Note>

## Step 5: Deploying

With your application complete, you are ready to deploy with ZEIT Now using **just a single command**:

<Snippet dark text="now" />
<Caption>
  Deploying the application with the <InlineCode>now</InlineCode> command.
</Caption>

That's it. (_Thanks ZEIT!_)

## Step 5.1: View the Deployment

The output from the `now` command tells you if the deployment was successful and where to go in the browser to see the output.

```bash
dev/_zeit/faunadb-zeit-fql-demo
▶ now
> Deploying ~/dev/_zeit/faunadb-zeit-fql-demo under danieltodonnell
> Using project faunadb-zeit-fql-demo
> https://faunadb-zeit-fql-demo-h41neo7ut.now.sh [v2] [1s]
> Ready! Deployed to https://faunadb-zeit-fql-demo.danieltodonnell.now.sh [in clipboard] [10s]
```

Open up your browser, paste in the url that the `now` command added to the clipboard, add `/api` to the path and visit your serverless function.

If you have followed all the steps, and correctly setup the fauna secret, then you should see something like this:

<Image
  src={`${
    process.env.ASSETS
  }/guides/deploying-a-faunadb-powered-api-with-node-and-zeit-now/json-output.png`}
  width={852 / 2}
  height={1376 / 2}
  oversize
/>
<Caption>The JSON output from the FaunaDB database.</Caption>

If you want to deploy your Node.js + FaunaDB project when you push to a Git repository, you can use either [Now for GitHub](/docs/v2/advanced/now-for-github/) or [Now for GitLab](/docs/v2/advanced/now-for-gitlab/) to have your project automatically deployed on every push, and aliased on push to master.

export default ({ children }) => <Guide meta={meta}>{children}</Guide>

export const config = {
  amp: 'hybrid'
}
